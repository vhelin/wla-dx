#
# WLA DX Windows XP compatible 32-bit build using MinGW
#
trigger:
- master

pool:
  vmImage: 'windows-latest'

variables:
  buildPlatform: 'x86'
  buildConfiguration: 'Release'

steps:
- checkout: self
  displayName: 'Checkout code'

# Install MinGW
- powershell: |
    Write-Host "Installing MinGW for Windows XP compatibility..."
    choco install mingw --version=8.1.0 --force -y
    
    Write-Host "MinGW installed successfully"
    
    # Add to PATH
    $env:Path = "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw32\bin;$env:Path"
    
    # Verify installation
    gcc --version
    g++ --version
  displayName: 'Install MinGW'
  timeoutInMinutes: 10

# Build using CMake with MinGW
- bash: |
    export PATH="/c/ProgramData/chocolatey/lib/mingw/tools/install/mingw32/bin:$PATH"
    
    echo "Building WLA DX with MinGW for Windows XP..."
    
    mkdir build-xp
    cd build-xp
    
    # Configure with MinGW Makefiles targeting Windows XP
    cmake .. -G "MinGW Makefiles" \
             -DCMAKE_C_COMPILER=gcc \
             -DCMAKE_BUILD_TYPE=Release \
             -DCMAKE_C_FLAGS="-m32 -D_WIN32_WINNT=0x0501 -DWINVER=0x0501 -static-libgcc"
    
    # Build
    cmake --build . --config Release
    
    echo "Build complete!"
  displayName: 'Build with MinGW (XP compatible)'

# Verify binaries exist and are valid Windows executables
- powershell: |
    Write-Host "Verifying Windows XP compatible binaries..."
    
    $binariesPath = "build-xp\binaries"
    
    if (Test-Path $binariesPath) {
        $exeFiles = Get-ChildItem -Path $binariesPath -Filter *.exe
        
        if ($exeFiles.Count -eq 0) {
            Write-Host "ERROR: No executables found in $binariesPath"
            exit 1
        }
        
        Write-Host "Found $($exeFiles.Count) executable(s):"
        
        foreach ($exe in $exeFiles) {
            Write-Host "`n  - $($exe.Name)"
            Write-Host "    Size: $([math]::Round($exe.Length / 1KB, 2)) KB"
            
            # Verify it's a valid PE executable
            $bytes = [System.IO.File]::ReadAllBytes($exe.FullName)
            if ($bytes[0] -eq 0x4D -and $bytes[1] -eq 0x5A) {
                Write-Host "    Status: ✓ Valid Windows executable"
            } else {
                Write-Host "    Status: ✗ Invalid executable format"
                exit 1
            }
        }
        
        Write-Host "`n✓ All binaries verified successfully"
    } else {
        Write-Host "ERROR: Binaries directory not found: $binariesPath"
        exit 1
    }
  displayName: 'Verify binaries'

# Run tests
- bash: |
    export PATH="$PWD/build-xp/binaries:$PATH"
    ./run_tests.sh -windows-x86
  workingDirectory: '$(Build.SourcesDirectory)'
  displayName: 'Run tests'
  continueOnError: true

# Save environment info
- powershell: |
    gci env:* | sort-object name | Format-Table -AutoSize | Out-File $env:BUILD_ARTIFACTSTAGINGDIRECTORY/environment-variables.txt
  displayName: 'Save environment variables'

# Copy binaries to staging
- task: CopyFiles@2
  inputs:
    sourceFolder: 'build-xp/binaries'
    contents: '**'
    TargetFolder: '$(Build.ArtifactStagingDirectory)/binaries'
  displayName: 'Copy build artifacts'

# Publish artifacts
- task: PublishBuildArtifacts@1
  inputs:
    pathtoPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'WLA-DX-Windows-XP-MinGW-32bit'
  displayName: 'Publish artifacts'
