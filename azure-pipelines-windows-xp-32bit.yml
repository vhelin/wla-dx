#
# WLA DX Windows XP compatible 32-bit build using MSYS2 MinGW
#
trigger:
- master

pool:
  vmImage: 'windows-latest'

steps:
- checkout: self
  displayName: 'Checkout code'

# Setup MSYS2 MinGW 32-bit
- bash: |
    # MSYS2 is pre-installed on Azure agents
    export PATH="/c/msys64/mingw32/bin:/c/msys64/usr/bin:$PATH"
    
    echo "Installing 32-bit MinGW toolchain..."
    pacman -Sy --noconfirm mingw-w64-i686-toolchain mingw-w64-i686-cmake
    
    echo "Verifying installation..."
    gcc --version
    gcc -dumpmachine
  displayName: 'Setup MSYS2 MinGW 32-bit'

# Build
- bash: |
    export PATH="/c/msys64/mingw32/bin:/c/msys64/usr/bin:$PATH"
    
    echo "Building WLA DX with 32-bit MinGW for Windows XP..."
    
    mkdir build-xp
    cd build-xp
    
    cmake .. -G "MinGW Makefiles" \
             -DCMAKE_C_COMPILER=gcc \
             -DCMAKE_BUILD_TYPE=Release \
             -DCMAKE_C_FLAGS="-D_WIN32_WINNT=0x0501 -DWINVER=0x0501 -static-libgcc"
    
    cmake --build . --config Release
    
    echo "✓ Build complete!"
  displayName: 'Build with MSYS2 MinGW 32-bit'

# Verify binaries
- powershell: |
    if (Test-Path "build-xp\binaries") {
        $exes = Get-ChildItem -Path "build-xp\binaries" -Filter *.exe
        Write-Host "✓ Found $($exes.Count) executables"
        $exes | ForEach-Object { Write-Host "  - $($_.Name)" }
    } else {
        Write-Host "ERROR: No binaries found"
        exit 1
    }
  displayName: 'Verify binaries'

# Run tests
- bash: |
    export PATH="$PWD/build-xp/binaries:$PATH"
    ./run_tests.sh -windows-x86
  displayName: 'Run tests'

# Publish
- task: PublishBuildArtifacts@1
  inputs:
    pathtoPublish: 'build-xp/binaries'
    artifactName: 'WLA-DX-Windows-XP-32bit'
